name: CI (lint, build, and test)
on:
    push:
         
         branches:
            - '*'
            - '!gh-pages'
         tags:
            - '*'
         paths:
            - 'src/**.js'
jobs:
    lint:
        name: Lint code
        runs-on: ubuntu-latest
        steps:
        
        - name: Checkout things
          uses: actions/checkout@v1
        - name: Node.JS 10.x
          uses: actions/setup-node@v2
          with:
           node-version: "14"
        - name: Install Yarn
          run: npm i -g yarn
        - name: Install dependencies
          run: yarn install
        - name: Test Code Linting
          run: npm run lint

        - name: Commit the fix
          run: |
             git add --all
             git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
             git config --local user.name "github-actions[bot]"
             git commit -m "ESLint fix" -a
          continue-on-error: true
        - name: Push the fix
          uses: ad-m/github-push-action@master
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            branch: ${{ github.ref }}
          continue-on-error: true
        - name: Save Code Linting Report JSON
        # npm script for ESLint
        # eslint --output-file eslint_report.json --format json src
        # See https://eslint.org/docs/user-guide/command-line-interface#options
          run: npm run lint:report
        # Continue to the next step even if this fails
          continue-on-error: true
        - name: Annotate Code Linting Results
          uses: ataylorme/eslint-annotate-action@1.1.2
          with:
           repo-token: "${{ secrets.GITHUB_TOKEN }}"
           report-json: "eslint_report.json"
        - name: Upload ESLint report
          uses: actions/upload-artifact@v1
          with:
             name: eslint_report.json
             path: eslint_report.json
    build:
          name: Build
          runs-on: ubuntu-latest
          
          steps:
             - name: Checkout things
               uses: actions/checkout@v2
             - name: Setup Node.js v14
               uses: actions/setup-node@v2
               with:
                 node-version: '14'
             - name: Install Yarn
               run: npm i -g yarn

             - name: Pull
               run: |

                git config pull.rebase false
                git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                git config --local user.name "github-actions[bot]"
                git pull origin ${GITHUB_REF##*/}
                
             - name: Generate browser-supported dist
               run: |
                yarn install
                yarn build:dev
                yarn build:prod
             - name: Commit the dist
               run: |
                
                git add --all
                
                git commit -m "Generated browser-supported dist" -a
               continue-on-error: true
             - name: Push the dist
               uses: ad-m/github-push-action@master
               with:
                 github_token: ${{ secrets.GITHUB_TOKEN }}
                 branch: ${{ github.ref }}
               continue-on-error: true
    test_prod:
         name: Test prod bundle
         runs-on: ubuntu-latest
         needs: build
         steps:
           - name: Checkout things
             uses: actions/checkout@v2
           - name: Setup Node.js v14
             uses: actions/setup-node@v2
             with:
               node-version: 14
           - name: Run test
             run: npm run test
             
    test_dev:
       name: Test dev bundle
       runs-on: ubuntu-latest
       needs: build
       steps:
          - name: Checkout things
            uses: actions/checkout@v2
          - name: Setup Node.js v14
            uses: actions/setup-node@v2
            with:
              node-version: '14'
          - name: Run test
            run: export BLJS_DEV=true && npm run test
  
